################################################################################
# Apache Kafka KRaft Combined Mode Configuration
# Generated by Ansible for {{ broker.name }}
# Node ID: {{ broker.node_id }}
################################################################################

############################# Server Basics #############################

# Combined mode: broker + controller
process.roles={{ broker.process_roles | default('broker,controller') }}

# Unique node ID for this broker
node.id={{ broker.node_id }}

############################# Controller Configuration #############################

# Controller quorum voters - all nodes in the cluster
controller.quorum.voters={{ kafka_controller_quorum_voters }}

############################# Socket Server Settings #############################

# Listeners for client and controller communication
listeners={% for listener in broker.listeners %}{{ listener }}{% if not loop.last %},{% endif %}{% endfor %}

# Advertised listeners for client connections
advertised.listeners={% for listener in broker.advertised_listeners %}{{ listener }}{% if not loop.last %},{% endif %}{% endfor %}

# Security protocol mapping
listener.security.protocol.map={{ kafka_listener_security_protocol_map | default('CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,SSL:SSL,SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_SSL:SASL_SSL') }}

# Listener name for controller communication
controller.listener.names={{ kafka_controller_listener_name | default('CONTROLLER') }}

# Listener name for inter-broker communication
inter.broker.listener.name={{ kafka_inter_broker_listener_name | default('PLAINTEXT') }}

############################# SSL Configuration #############################
{% if kafka_ssl_enabled | default(false) %}

ssl.keystore.location={{ broker.base_path }}/ssl/kafka.server.keystore.jks
ssl.keystore.password={{ kafka_ssl_keystore_password | default('changeit') }}
ssl.key.password={{ kafka_ssl_key_password | default('changeit') }}
ssl.truststore.location={{ broker.base_path }}/ssl/kafka.server.truststore.jks
ssl.truststore.password={{ kafka_ssl_truststore_password | default('changeit') }}
ssl.client.auth={{ kafka_ssl_client_auth | default('none') }}
ssl.enabled.protocols={{ kafka_ssl_enabled_protocols | default('TLSv1.2,TLSv1.3') }}
ssl.protocol={{ kafka_ssl_protocol | default('TLSv1.3') }}
{% else %}
# SSL is disabled. Set kafka_ssl_enabled: true to enable.
{% endif %}

############################# Log Basics #############################

# Directory for Kafka data (log segments)
log.dirs={{ broker.base_path }}/data

############################# Cluster Configuration #############################

# Unique cluster ID (same for all brokers)
cluster.id={{ kafka_cluster_id }}

############################# Topic Defaults #############################

# Default number of partitions for auto-created topics
num.partitions={{ kafka_num_partitions | default(3) }}

# Default replication factor for auto-created topics
default.replication.factor={{ kafka_default_replication_factor | default(3) }}

# Minimum in-sync replicas
min.insync.replicas={{ kafka_min_insync_replicas | default(2) }}

############################# Replication Settings #############################

offsets.topic.replication.factor={{ kafka_offsets_topic_replication_factor | default(3) }}
offsets.topic.num.partitions={{ kafka_offsets_topic_num_partitions | default(50) }}
transaction.state.log.replication.factor={{ kafka_transaction_state_log_replication_factor | default(3) }}
transaction.state.log.min.isr={{ kafka_transaction_state_log_min_isr | default(2) }}

############################# Log Retention Policy #############################

# Retain logs for this many hours
log.retention.hours={{ kafka_log_retention_hours | default(168) }}

# Maximum size of a log segment file
log.segment.bytes={{ kafka_log_segment_bytes | default(1073741824) }}

# Interval to check log retention policy
log.retention.check.interval.ms={{ kafka_log_retention_check_interval_ms | default(300000) }}

{% if kafka_log_retention_bytes is defined %}
# Maximum size of logs per partition before deletion
log.retention.bytes={{ kafka_log_retention_bytes }}
{% endif %}

############################# Log Flush Settings #############################

log.flush.interval.messages={{ kafka_log_flush_interval_messages | default(10000) }}
log.flush.interval.ms={{ kafka_log_flush_interval_ms | default(1000) }}

############################# Network Settings #############################

# Number of threads for network requests
num.network.threads={{ kafka_num_network_threads | default(3) }}

# Number of threads for I/O operations
num.io.threads={{ kafka_num_io_threads | default(8) }}

# Socket buffer sizes
socket.send.buffer.bytes={{ kafka_socket_send_buffer_bytes | default(102400) }}
socket.receive.buffer.bytes={{ kafka_socket_receive_buffer_bytes | default(102400) }}
socket.request.max.bytes={{ kafka_socket_request_max_bytes | default(104857600) }}

############################# Group Coordinator Settings #############################

group.initial.rebalance.delay.ms={{ kafka_group_initial_rebalance_delay_ms | default(0) }}
group.min.session.timeout.ms={{ kafka_group_min_session_timeout_ms | default(6000) }}
group.max.session.timeout.ms={{ kafka_group_max_session_timeout_ms | default(300000) }}

############################# Zookeeper (Disabled in KRaft) #############################

# ZooKeeper is not used in KRaft mode
# zookeeper.connect=

############################# JMX Configuration #############################
{% if kafka_jmx_enabled | default(false) %}
# JMX settings (configured via JVM_OPTS, not here)
# JMX_PORT={{ broker.jmx_port | default(9999) }}
{% endif %}

############################# Additional Custom Properties #############################
{% if kafka_extra_properties is defined %}
{% for key, value in kafka_extra_properties.items() %}
{{ key }}={{ value }}
{% endfor %}
{% endif %}